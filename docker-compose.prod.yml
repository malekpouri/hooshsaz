version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: hooshsaz_db_prod
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: hooshsaz
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    networks:
      - hooshsaz-network-prod
    restart: always

  backend:
    build: ./backend
    container_name: hooshsaz_backend_prod
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://user:password@postgres:5432/hooshsaz
      PORT: 5000
      JWT_SECRET: supersecretkey
      # In production, you might want to change this to the actual Ollama server URL if not running locally
      # For now, we keep it as host.docker.internal assuming Ollama is on the host
    ports:
      - "5000:5000"
    depends_on:
      - postgres
    networks:
      - hooshsaz-network-prod
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: http://localhost:5000
    container_name: hooshsaz_frontend_prod
    environment:
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - hooshsaz-network-prod
    restart: always

networks:
  hooshsaz-network-prod:
    driver: bridge

volumes:
  postgres_data_prod:
